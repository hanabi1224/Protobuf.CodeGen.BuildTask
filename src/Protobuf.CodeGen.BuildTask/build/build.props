<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask
    TaskName="ProtobufCodeGenTask"
    AssemblyFile="$(MSBuildThisFileDirectory)Protobuf.CodeGen.BuildTask.dll" />

  <UsingTask
    TaskName="GetProtobufCompilerOSSpecificFolderTask"
    AssemblyFile="$(MSBuildThisFileDirectory)Protobuf.CodeGen.BuildTask.dll" />
  
  <Target Name="ProtobufCodeGen" BeforeTargets="AssignTargetPaths">
    <Message Text="OS: $(OS)" Importance="high" />
    <GetProtobufCompilerOSSpecificFolderTask>
      <Output TaskParameter="FolderName" PropertyName="ProtobufToolFolderName"/>
    </GetProtobufCompilerOSSpecificFolderTask>
    <Message Text="ProtobufToolFolderName: $(ProtobufToolFolderName)" Importance="high" />
    <ItemGroup>
      <ProtoFilesToCompile Include="$(MSBuildProjectDirectory)/**/*.proto" />
    </ItemGroup>    
    <PropertyGroup>
      <ProtobufToolImportPath Condition="$(ProtobufToolImportPath) == ''">$(MSBuildThisFileDirectory)../../../google.protobuf.tools/3.6.1/tools/</ProtobufToolImportPath>
      <ProtoCompilerToolPath Condition="$(ProtoCompilerToolPath) == ''">$(ProtobufToolImportPath)$(ProtobufToolFolderName)/protoc</ProtoCompilerToolPath>
      <ProtobufCodeGenFolder Condition="$(ProtobufCodeGenFolder) == ''">$([System.IO.Path]::Combine('$(MSBuildProjectDirectory)', '_ProtobufCodeGen'))</ProtobufCodeGenFolder>
    </PropertyGroup>
    <ProtobufCodeGenTask ProtoCompilerToolPath="$(ProtoCompilerToolPath)"
                         OutputDir="$(ProtobufCodeGenFolder)"
                         ProtoPaths="$(ProtobufToolImportPath)"
                         FileNames="@(ProtoFilesToCompile)" />
    <ItemGroup>
      <Compile Include="$(ProtobufCodeGenFolder)/**/*.cs" />
    </ItemGroup>
    <CreateItem Include="@(ProtoFilesToCompile)">
      <Output TaskParameter="Include" ItemName="EmbeddedResource"/>
    </CreateItem>
  </Target>
  
</Project>
